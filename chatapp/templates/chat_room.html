<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat – {{ room_name }}</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { 
      font-family: "Inter", sans-serif;
    }
    audio { position: absolute; left: -9999px; opacity: 0; }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #0a0a0a;
    }
    ::-webkit-scrollbar-thumb {
      background: #404040;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #505050;
    }

    /* Message animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-animation {
      animation: fadeIn 0.3s ease-out;
    }

    /* Pulse animation for call */
    @keyframes pulse-ring {
      0% { transform: scale(0.95); opacity: 0.8; }
      100% { transform: scale(1.1); opacity: 0; }
    }

    .pulse-ring {
      animation: pulse-ring 2s infinite;
    }

    /* Voice recording animation */
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    .recording-pulse {
      animation: pulse 1.5s infinite;
    }

    /* File upload preview */
    .file-preview {
      transition: all 0.3s ease;
    }

    .file-preview:hover {
      transform: translateY(-2px);
    }
  </style>
</head>

<body class="bg-black text-white h-screen flex flex-col">

  <!-- HEADER -->
  <header class="sticky top-0 z-20 bg-black border-b border-gray-800 px-4 py-3 md:px-6 md:py-4">
    <div class="flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="relative">
          <div class="w-3 h-3 bg-gray-300 rounded-full absolute -right-0.5 -top-0.5 border-2 border-black"></div>
          <div class="w-10 h-10 bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg flex items-center justify-center border border-gray-700">
            <span class="text-gray-300 font-bold text-lg">#</span>
          </div>
        </div>
        <div>
          <h1 class="text-lg md:text-xl font-bold text-white">{{ room_name }}</h1>
          <p id="online-count" class="text-xs text-gray-400">Loading users...</p>
        </div>
      </div>

      <div class="flex items-center space-x-3 md:space-x-4">
        <!-- Call Button -->
        <button id="call-icon" class="relative p-2 rounded-lg bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 text-white border border-gray-700 transition-all duration-200 hover:border-gray-600 active:scale-95">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
        </button>

        <!-- User Info -->
        <div class="hidden md:flex items-center space-x-3 px-3 py-2 rounded-lg bg-gray-900 border border-gray-800">
          <div class="w-8 h-8 bg-gradient-to-r from-gray-700 to-gray-800 rounded-full flex items-center justify-center border border-gray-600">
            <span class="text-gray-300 font-bold text-sm">{{ request.user.username|first|upper }}</span>
          </div>
          <span class="font-medium text-gray-300">{{ request.user.username }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- SELECT USER POPUP -->
  <div id="call-user-popup" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-40 p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-800">
      <div class="p-6 border-b border-gray-800">
        <div class="flex items-center space-x-3">
          <div class="p-2 rounded-lg bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700">
            <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white">Start a Call</h3>
        </div>
        <p class="text-gray-400 mt-2">Select a user to call</p>
      </div>
      
      <div class="p-4 max-h-96 overflow-y-auto">
        <ul id="user-list" class="space-y-2"></ul>
      </div>
      
      <div class="p-4 border-t border-gray-800">
        <button onclick="closeUserPopup()"
                class="w-full px-4 py-3 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-xl font-medium transition-colors border border-gray-700">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- INCOMING CALL POPUP -->
  <div id="incoming-call-popup" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-gray-900 to-black rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-800">
      <div class="p-8 text-center">
        <div class="relative mx-auto w-24 h-24 mb-6">
          <div class="absolute inset-0 bg-gradient-to-r from-gray-600 to-gray-700 rounded-full pulse-ring"></div>
          <div class="relative w-full h-full bg-gradient-to-r from-gray-700 to-gray-800 rounded-full flex items-center justify-center border border-gray-600">
            <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
        </div>
        
        <h3 id="caller-name" class="text-2xl font-bold text-white mb-2"></h3>
        <p class="text-gray-400 mb-8">is calling you...</p>
        
        <div class="flex space-x-4">
          <button id="reject-call" class="flex-1 px-6 py-4 bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl font-semibold shadow-lg border border-gray-700 transition-all active:scale-95 flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            <span>Decline</span>
          </button>
          
          <button id="accept-call" class="flex-1 px-6 py-4 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white rounded-xl font-semibold shadow-lg border border-gray-600 transition-all active:scale-95 flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Accept</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- CHAT MESSAGES CONTAINER -->
  <main id="messages" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4">
    {% for m in messages %}
    <div class="message-animation flex {% if m.user.username == request.user.username %}justify-end{% else %}justify-start{% endif %}">
      <div class="max-w-[80%] md:max-w-[70%]">
        <div class="flex items-center space-x-2 mb-1 {% if m.user.username == request.user.username %}justify-end{% endif %}">
          {% if m.user.username != request.user.username %}
          <div class="w-6 h-6 bg-gradient-to-r from-gray-700 to-gray-800 rounded-full flex items-center justify-center border border-gray-600">
            <span class="text-gray-300 text-xs font-bold">{{ m.user.username|first|upper }}</span>
          </div>
          {% endif %}
          <span class="text-xs text-gray-400">{{ m.timestamp }}</span>
          {% if m.user.username == request.user.username %}
          <div class="w-6 h-6 bg-gradient-to-r from-gray-800 to-gray-900 rounded-full flex items-center justify-center border border-gray-700">
            <span class="text-gray-300 text-xs font-bold">{{ m.user.username|first|upper }}</span>
          </div>
          {% endif %}
        </div>
        
        <div class="{% if m.user.username == request.user.username %}bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700{% else %}bg-gray-900 border border-gray-800{% endif %} rounded-2xl p-4">
          <p class="leading-relaxed text-gray-100">{{ m.content }}</p>
          {% if m.attachments_json %}
            {% for attachment in m.attachments_json %}
              {% if attachment.type == 'image' %}
                <div class="mt-2 rounded-lg overflow-hidden border border-gray-800 relative group">
                  <img src="{{ attachment.url }}" alt="Attachment" class="w-full max-w-xs h-auto object-cover cursor-pointer" onclick="openImagePreview('{{ attachment.url }}', '{{ attachment.name }}')">
                  <button onclick="downloadFile('{{ attachment.url }}', '{{ attachment.name|default:"image.jpg" }}')" class="absolute top-2 right-2 w-8 h-8 bg-gray-900/80 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-800">
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </button>
                </div>
              {% elif attachment.type == 'file' %}
                <div class="mt-2 p-3 bg-gray-800 rounded-lg border border-gray-700 flex items-center space-x-3">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm text-gray-300 truncate">{{ attachment.name }}</p>
                    <p class="text-xs text-gray-400">{{ attachment.size }}</p>
                  </div>
                  <div class="flex items-center space-x-2">
                    <button onclick="downloadFile('{{ attachment.url }}', '{{ attachment.name }}')" class="w-8 h-8 bg-gray-700 rounded-lg flex items-center justify-center hover:bg-gray-600 transition-colors" title="Download">
                      <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </button>
                  </div>
                </div>
              {% elif attachment.type == 'voice' %}
                <div class="mt-2 p-3 bg-gray-800 rounded-lg border border-gray-700">
                  <div class="flex items-center space-x-3">
                    <button onclick="playVoiceNote('{{ attachment.url }}')" class="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center hover:bg-gray-700 transition-colors">
                      <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                      </svg>
                    </button>
                    <div class="flex-1">
                      <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                        <div class="voice-progress h-full bg-gray-400 w-0"></div>
                      </div>
                      <p class="text-xs text-gray-400 mt-1">Voice note • {{ attachment.duration }}</p>
                    </div>
                    <button onclick="downloadFile('{{ attachment.url }}', '{{ attachment.name|default:"voice_note.webm" }}')" class="w-8 h-8 bg-gray-700 rounded-lg flex items-center justify-center hover:bg-gray-600 transition-colors" title="Download">
                      <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </button>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
        
        {% if m.user.username != request.user.username %}
        <p class="text-xs text-gray-400 mt-1 ml-1">{{ m.user.username }}</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </main>

  <!-- MEDIA ATTACHMENTS PREVIEW -->
  <div id="media-preview" class="hidden px-4 pt-2 border-t border-gray-800 bg-black">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm text-gray-300">Attachments</span>
      <button onclick="clearMediaPreview()" class="text-gray-400 hover:text-gray-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="media-preview-content" class="flex space-x-2 overflow-x-auto pb-2"></div>
  </div>

  <!-- VOICE RECORDING UI -->
  <div id="voice-recording-ui" class="hidden fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-900 rounded-xl p-4 border border-gray-700 shadow-2xl z-40">
    <div class="flex items-center space-x-4">
      <div class="recording-pulse">
        <div class="w-10 h-10 bg-gradient-to-r from-gray-800 to-gray-900 rounded-full flex items-center justify-center border border-gray-600">
          <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
        </div>
      </div>
      <div>
        <p class="font-medium text-gray-300">Recording voice note...</p>
        <p id="recording-timer" class="text-sm text-gray-400">00:00</p>
      </div>
      <button id="stop-recording" class="ml-4 p-2 bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700">
        <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- MESSAGE INPUT -->
  <footer class="sticky bottom-0 bg-black/90 backdrop-blur-lg border-t border-gray-800 p-4 md:p-6">
    <form id="chat-form" class="flex items-center space-x-3">
      {% csrf_token %}
      
      <!-- Attachment Button -->
      <div class="relative">
        <button type="button" id="attachment-btn" class="p-3 rounded-xl bg-gray-900 hover:bg-gray-800 border border-gray-700 transition-colors">
          <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        </button>
        
        <!-- Attachment Menu -->
        <div id="attachment-menu" class="hidden absolute bottom-full left-0 mb-2 bg-gray-900 rounded-xl shadow-2xl border border-gray-700 p-2 min-w-[140px]">
          <input type="file" id="file-upload" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.txt" multiple>
          <input type="file" id="camera-upload" class="hidden" accept="image/*" capture="environment">
          
          <button type="button" onclick="event.stopPropagation(); openCameraPreview()" class="w-full flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors">
            <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span class="text-gray-300 text-sm">Camera</span>
          </button>

          <button type="button" onclick="event.stopPropagation(); document.getElementById('file-upload').click()" class="w-full flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors">
            <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span class="text-gray-300 text-sm">File</span>
          </button>

          <div class="border-t border-gray-800 my-1"></div>

          <button type="button" id="voice-note-btn" onclick="event.stopPropagation(); startVoiceRecording()" class="w-full flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors">
            <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            <span class="text-gray-300 text-sm">Voice Note</span>
          </button>
        </div>
      </div>
      
      <!-- Message Input -->
      <div class="flex-1 relative">
        <input id="message-input"
               type="text"
               placeholder="Type your message..."
               class="w-full px-5 py-4 bg-gray-900 text-gray-100 rounded-2xl border border-gray-700 focus:border-gray-500 focus:ring-1 focus:ring-gray-500 outline-none transition-all placeholder-gray-500">
      </div>
      
      <!-- Send Button -->
      <button type="submit" class="px-6 py-4 bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 text-white rounded-2xl font-semibold border border-gray-700 transition-all active:scale-95 flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
        <span class="hidden md:inline">Send</span>
      </button>
    </form>
  </footer>

  <!-- ACTIVE CALL UI -->
  <div id="active-call-ui"
       class="fixed bottom-6 right-6 bg-gradient-to-br from-gray-900 to-black 
              border border-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-5 hidden z-40">

    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center space-x-3">
        <div class="relative">
          <div class="w-12 h-12 bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl flex items-center justify-center border border-gray-700">
            <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
          <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-gray-300 rounded-full border-2 border-black"></div>
        </div>
        <div>
          <h3 id="call-with" class="font-bold text-white">Call Connected</h3>
          <div class="flex items-center space-x-2">
            <span id="call-status" class="text-xs text-gray-300 font-medium">Connected</span>
            <span class="text-gray-600">•</span>
            <span id="call-timer" class="text-xs text-gray-400 font-mono">00:00</span>
          </div>
        </div>
      </div>
      
      <button id="minimize-call" class="p-2 hover:bg-gray-800 rounded-lg border border-gray-700">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14" />
        </svg>
      </button>
    </div>

    <div class="space-y-4">
      <!-- Audio Level Indicator -->
      <div class="flex items-center space-x-3">
        <div class="flex-1 bg-gray-800 h-2 rounded-full overflow-hidden border border-gray-700">
          <div id="audio-level" class="h-full bg-gradient-to-r from-gray-600 to-gray-700 w-1/2"></div>
        </div>
        <span class="text-xs text-gray-400">Audio Level</span>
      </div>

      <!-- Call Controls -->
      <div class="grid grid-cols-3 gap-3">
        <button id="mute-btn"
                class="p-3 bg-gray-800 hover:bg-gray-700 rounded-xl flex flex-col items-center justify-center space-y-1 transition-colors border border-gray-700">
          <svg id="mute-icon" class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
          <span class="text-xs text-gray-400">Mute</span>
        </button>

        <button id="speaker-btn"
                class="p-3 bg-gray-800 hover:bg-gray-700 rounded-xl flex flex-col items-center justify-center space-y-1 transition-colors border border-gray-700">
          <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
          </svg>
          <span class="text-xs text-gray-400">Speaker</span>
        </button>

        <button id="end-call-btn"
                class="p-3 bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl flex flex-col items-center justify-center space-y-1 transition-all border border-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          <span class="text-xs text-gray-300">End</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MINIMIZED CALL UI -->
  <div id="minimized-call-ui" class="fixed bottom-6 right-6 bg-gray-900 rounded-xl shadow-lg p-3 hidden z-30 border border-gray-800">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg flex items-center justify-center border border-gray-700">
        <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
        </svg>
      </div>
      <div class="min-w-0">
        <p class="text-sm font-medium text-white truncate" id="minimized-call-name"></p>
        <p class="text-xs text-gray-400" id="minimized-call-timer">00:00</p>
      </div>
      <button id="restore-call" class="p-2 hover:bg-gray-800 rounded-lg border border-gray-700">
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
        </svg>
      </button>
    </div>
  </div>

  <!-- CAMERA PREVIEW MODAL -->
  <div id="camera-preview-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="relative max-w-4xl max-h-full bg-gray-900 rounded-2xl overflow-hidden border border-gray-700">
      <div class="p-4 border-b border-gray-700 flex items-center justify-between">
        <h3 class="text-white font-medium">Take Photo</h3>
        <button onclick="closeCameraPreview()" class="text-gray-400 hover:text-gray-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="relative">
        <video id="camera-video" autoplay playsinline class="w-full max-h-96 object-cover"></video>
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-4">
          <button id="capture-btn" class="w-16 h-16 bg-white rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors shadow-lg">
            <div class="w-12 h-12 bg-gray-800 rounded-full border-4 border-white"></div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- IMAGE PREVIEW MODAL -->
  <div id="image-preview-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="relative max-w-4xl max-h-full">
      <img id="preview-image" src="" alt="Preview" class="max-w-full max-h-full object-contain">
      <button onclick="closeImagePreview()" class="absolute top-4 right-4 w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center hover:bg-gray-800 border border-gray-700">
        <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- FILE PREVIEW MODAL -->
  <div id="file-preview-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="relative max-w-4xl max-h-full bg-gray-900 rounded-lg overflow-hidden">
      <div class="p-4 border-b border-gray-700 flex items-center justify-between">
        <h3 id="file-preview-title" class="text-white font-medium">File Preview</h3>
        <button onclick="closeFilePreview()" class="text-gray-400 hover:text-gray-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-4">
        <iframe id="file-preview-iframe" src="" class="w-full h-96 border border-gray-700 rounded"></iframe>
      </div>
    </div>
  </div>

  <!-- AUDIO ELEMENTS -->
  <audio id="remoteAudio" autoplay></audio>
  <audio id="ringtone" loop>
    <source src="https://assets.mixkit.co/active_storage/sfx/268/268-preview.mp3" type="audio/mpeg">
  </audio>

  <script>
    /* ------------------------------
          GLOBAL VARIABLES
    ------------------------------ */

    const CURRENT_USER = "{{ request.user.username|escapejs }}";
    const roomName = "{{ room_name|escapejs }}";

    const socket = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") +
      location.host +
      "/ws/chat/" + roomName + "/"
    );

    let onlineUsers = new Set();
    let pc = null;
    let localStream = null;
    let callTarget = null;
    let ringTimeout = null;
    let callTimerInterval = null;
    let callSeconds = 0;
    let isCallMinimized = false;
    let audioContext = null;
    let analyser = null;
    let audioInterval = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordingTimerInterval = null;
    let recordingSeconds = 0;
    let attachments = [];

    const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    /* ------------------------------
          CHAT MESSAGE DISPLAY
    ------------------------------ */

    function displayChatMessage(username, message, isCurrentUser = false, attachments = []) {
      const messagesContainer = document.getElementById("messages");
      const isMe = username === CURRENT_USER || isCurrentUser;
      
      const messageDiv = document.createElement("div");
      messageDiv.className = `message-animation flex ${isMe ? 'justify-end' : 'justify-start'}`;
      
      let attachmentsHTML = '';
      if (attachments && attachments.length > 0) {
        attachments.forEach(attachment => {
          if (attachment.type === 'image') {
            attachmentsHTML += `
              <div class="mt-2 rounded-lg overflow-hidden border border-gray-800 relative group">
                <img src="${attachment.url}" alt="${attachment.name || 'Image'}" class="w-full max-w-xs h-auto object-cover cursor-pointer" onclick="openImagePreview('${attachment.url}', '${attachment.name || 'image.jpg'}')">
                <button onclick="downloadFile('${attachment.url}', '${attachment.name || 'image.jpg'}')" class="absolute top-2 right-2 w-8 h-8 bg-gray-900/80 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-800">
                  <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </button>
              </div>
            `;
          } else if (attachment.type === 'file') {
            attachmentsHTML += `
              <div class="mt-2 p-3 bg-gray-800 rounded-lg border border-gray-700 flex items-center space-x-3">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <div class="flex-1 min-w-0">
                  <p class="text-sm text-gray-300 truncate">${attachment.name || 'File'}</p>
                  <p class="text-xs text-gray-400">${attachment.size || 'Unknown size'}</p>
                </div>
                <div class="flex items-center space-x-2">
                  <button onclick="downloadFile('${attachment.url}', '${attachment.name || 'file'}')" class="w-8 h-8 bg-gray-700 rounded-lg flex items-center justify-center hover:bg-gray-600 transition-colors" title="Download">
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </button>
                </div>
              </div>
            `;
          } else if (attachment.type === 'voice') {
            attachmentsHTML += `
              <div class="mt-2 p-3 bg-gray-800 rounded-lg border border-gray-700">
                <div class="flex items-center space-x-3">
                  <button onclick="playVoiceNote('${attachment.url}')" class="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    </svg>
                  </button>
                  <div class="flex-1">
                    <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                      <div class="voice-progress h-full bg-gray-400 w-0"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Voice note • ${attachment.duration || '00:00'}</p>
                  </div>
                  <button onclick="downloadFile('${attachment.url}', '${attachment.name || 'voice_note.webm'}')" class="w-8 h-8 bg-gray-700 rounded-lg flex items-center justify-center hover:bg-gray-600 transition-colors" title="Download">
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </button>
                </div>
              </div>
            `;
          }
        });
      }
      
      messageDiv.innerHTML = `
        <div class="max-w-[80%] md:max-w-[70%]">
          <div class="flex items-center space-x-2 mb-1 ${isMe ? 'justify-end' : ''}">
            ${!isMe ? `
              <div class="w-6 h-6 bg-gradient-to-r from-gray-700 to-gray-800 rounded-full flex items-center justify-center border border-gray-600">
                <span class="text-gray-300 text-xs font-bold">${username ? username.charAt(0).toUpperCase() : '?'}</span>
              </div>
            ` : ''}
            <span class="text-xs text-gray-400">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            ${isMe ? `
              <div class="w-6 h-6 bg-gradient-to-r from-gray-800 to-gray-900 rounded-full flex items-center justify-center border border-gray-700">
                <span class="text-gray-300 text-xs font-bold">${CURRENT_USER ? CURRENT_USER.charAt(0).toUpperCase() : 'U'}</span>
              </div>
            ` : ''}
          </div>
          
          <div class="${isMe ? 'bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700' : 'bg-gray-900 border border-gray-800'} rounded-2xl p-4">
            ${message ? `<p class="leading-relaxed text-gray-100 mb-2">${escapeHTML(message)}</p>` : ''}
            ${attachmentsHTML}
          </div>
          
          ${!isMe ? `
            <p class="text-xs text-gray-400 mt-1 ml-1">${username}</p>
          ` : ''}
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    /* ------------------------------
          ESCAPING HTML
    ------------------------------ */

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;",
        '"': "&quot;", "'": "&#39;"
      }[m]));
    }

    /* ------------------------------
          WEBSOCKET HANDLING
    ------------------------------ */

    socket.onmessage = async (e) => {
      const data = JSON.parse(e.data);

      /* ONLINE USERS LIST */
      if (data.type === "online_list") {
        onlineUsers = new Set(data.users);
        onlineUsers.delete(CURRENT_USER);
        document.getElementById('online-count').textContent = `${onlineUsers.size} user${onlineUsers.size !== 1 ? 's' : ''} online`;
        renderUserList();
        return;
      }

      if (data.type === "user_join") {
        onlineUsers.add(data.username);
        document.getElementById('online-count').textContent = `${onlineUsers.size} user${onlineUsers.size !== 1 ? 's' : ''} online`;
        renderUserList();
        return;
      }

      if (data.type === "user_leave") {
        onlineUsers.delete(data.username);
        document.getElementById('online-count').textContent = `${onlineUsers.size} user${onlineUsers.size !== 1 ? 's' : ''} online`;
        renderUserList();
        return;
      }

      /* ---------------- CALLING EVENTS ---------------- */

      if (data.type === "call_request") {
        if (data.target === CURRENT_USER) { 
          showIncomingCall(data.from); 
        }
        return;
      }

      if (data.type === "call_accept") {
        if (data.target === CURRENT_USER) {
          clearTimeout(ringTimeout);
          startAsCaller();
        }
        return;
      }

      if (data.type === "call_reject") {
        if (data.target === CURRENT_USER) {
          showNotification("Call was ended", "error");
          cleanupCall();
        }
        return;
      }

      if (data.type === "call_timeout") {
        if (data.target === CURRENT_USER) {
          showNotification("Call timed out", "warning");
          cleanupCall();
        }
        return;
      }

      if (data.type === "call_failed") {
        if (data.target === CURRENT_USER) {
          showNotification("Call failed", "error");
          cleanupCall();
        }
        return;
      }

      /* OFFER */
      if (data.type === "offer" && data.target === CURRENT_USER) {
        await handleOffer(data.offer, data.from);
        return;
      }

      /* ANSWER */
      if (data.type === "answer" && data.target === CURRENT_USER) {
        if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        return;
      }

      /* ICE */
      if (data.type === "ice" && data.target === CURRENT_USER) {
        if (pc && data.candidate) {
          try { 
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); 
          } catch (err) { 
            console.warn("ICE add failed", err); 
          }
        }
        return;
      }

      /* Normal chat message with attachments */
      if (data.message || data.attachments) {
        displayChatMessage(data.username, data.message, data.username === CURRENT_USER, data.attachments);
      }
    };

    /* ------------------------------
          NOTIFICATION SYSTEM
    ------------------------------ */

    function showNotification(message, type = "info") {
      const colors = {
        info: "bg-gray-800 border-gray-700",
        success: "bg-gray-800 border-gray-600",
        warning: "bg-gray-800 border-gray-600",
        error: "bg-gray-800 border-gray-700"
      };
      
      const notification = document.createElement('div');
      notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-gray-300 border px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce-in`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    /* ------------------------------
          ATTACHMENT HANDLING
    ------------------------------ */

    document.getElementById('attachment-btn').addEventListener('click', function(e) {
      const menu = document.getElementById('attachment-menu');
      menu.classList.toggle('hidden');
      e.stopPropagation();
    });

    document.addEventListener('click', function() {
      document.getElementById('attachment-menu').classList.add('hidden');
    });

    document.getElementById('file-upload').addEventListener('change', function(e) {
      const files = e.target.files;
      for (let file of files) {
        previewFile(file);
      }
      this.value = '';
    });

    document.getElementById('camera-upload').addEventListener('change', function(e) {
      const files = e.target.files;
      for (let file of files) {
        previewFile(file, true);
      }
      this.value = '';
    });

    async function uploadFileToServer(file, filename = null) {
      const formData = new FormData();
      formData.append('file', file, filename || file.name);
      formData.append('room', roomName);

      try {
        const response = await fetch('/media/upload/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });

        if (response.ok) {
          const data = await response.json();
          return data.url;
        } else {
          console.error('Upload failed:', response.statusText);
          return null;
        }
      } catch (error) {
        console.error('Upload error:', error);
        return null;
      }
    }

    async function previewFile(file, isCamera = false) {
      const previewContent = document.getElementById('media-preview-content');
      const previewContainer = document.getElementById('media-preview');

      // Upload file to server first
      const serverUrl = await uploadFileToServer(file);

      if (!serverUrl) {
        showNotification(`Failed to upload ${file.name}`, 'error');
        return;
      }

      const attachment = {
        file: file,
        url: serverUrl,
        type: file.type.startsWith('image/') ? 'image' : 'file',
        name: file.name,
        size: formatFileSize(file.size),
        isCamera: isCamera
      };

      attachments.push(attachment);

      const previewDiv = document.createElement('div');
      previewDiv.className = 'file-preview flex-shrink-0 w-20 h-20 relative';

      if (attachment.type === 'image') {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewDiv.innerHTML = `
            <img src="${e.target.result}" alt="${file.name}" class="w-full h-full object-cover rounded-lg border border-gray-700">
            <button onclick="removeAttachment(${attachments.length - 1})" class="absolute -top-1 -right-1 w-5 h-5 bg-gray-900 rounded-full border border-gray-700 flex items-center justify-center hover:bg-gray-800">
              <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          `;
          previewContent.appendChild(previewDiv);
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        previewDiv.innerHTML = `
          <div class="w-full h-full bg-gray-800 rounded-lg border border-gray-700 flex items-center justify-center">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <button onclick="removeAttachment(${attachments.length - 1})" class="absolute -top-1 -right-1 w-5 h-5 bg-gray-900 rounded-full border border-gray-700 flex items-center justify-center hover:bg-gray-800">
              <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        `;
        previewContent.appendChild(previewDiv);
        previewContainer.classList.remove('hidden');
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function removeAttachment(index) {
      attachments.splice(index, 1);
      updateMediaPreview();
    }

    function clearMediaPreview() {
      attachments = [];
      document.getElementById('media-preview').classList.add('hidden');
      document.getElementById('media-preview-content').innerHTML = '';
    }

    function updateMediaPreview() {
      const previewContent = document.getElementById('media-preview-content');
      const previewContainer = document.getElementById('media-preview');
      
      previewContent.innerHTML = '';
      
      if (attachments.length === 0) {
        previewContainer.classList.add('hidden');
        return;
      }
      
      attachments.forEach((attachment, index) => {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'file-preview flex-shrink-0 w-20 h-20 relative';
        
        if (attachment.type === 'image') {
          if (attachment.file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              previewDiv.innerHTML = `
                <img src="${e.target.result}" alt="${attachment.name}" class="w-full h-full object-cover rounded-lg border border-gray-700">
                <button onclick="removeAttachment(${index})" class="absolute -top-1 -right-1 w-5 h-5 bg-gray-900 rounded-full border border-gray-700 flex items-center justify-center hover:bg-gray-800">
                  <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              `;
              previewContent.appendChild(previewDiv);
            };
            reader.readAsDataURL(attachment.file);
          }
        } else {
          previewDiv.innerHTML = `
            <div class="w-full h-full bg-gray-800 rounded-lg border border-gray-700 flex items-center justify-center">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <button onclick="removeAttachment(${index})" class="absolute -top-1 -right-1 w-5 h-5 bg-gray-900 rounded-full border border-gray-700 flex items-center justify-center hover:bg-gray-800">
                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          `;
          previewContent.appendChild(previewDiv);
        }
      });
      
      previewContainer.classList.remove('hidden');
    }

    /* ------------------------------
          VOICE NOTE RECORDING
    ------------------------------ */

    document.getElementById('voice-note-btn').addEventListener('click', async function() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        startVoiceRecording(stream);
      } catch (error) {
        console.error('Error accessing microphone:', error);
        showNotification('Cannot access microphone', 'error');
      }
    });

    function startVoiceRecording(stream) {
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];
      recordingSeconds = 0;

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: 'audio/webm' });

        // Upload voice note to server with proper filename
        const serverUrl = await uploadFileToServer(blob, 'voice_note.webm');

        if (!serverUrl) {
          showNotification('Failed to upload voice note', 'error');
          stream.getTracks().forEach(track => track.stop());
          return;
        }

        const attachment = {
          file: blob,
          url: serverUrl,
          type: 'voice',
          duration: formatTime(recordingSeconds),
          name: 'voice_note.webm',
          size: formatFileSize(blob.size)
        };

        attachments.push(attachment);
        updateMediaPreview();

        stream.getTracks().forEach(track => track.stop());
      };

      mediaRecorder.start();
      showVoiceRecordingUI();
      startRecordingTimer();
    }

    function showVoiceRecordingUI() {
      document.getElementById('voice-recording-ui').classList.remove('hidden');
    }

    function hideVoiceRecordingUI() {
      document.getElementById('voice-recording-ui').classList.add('hidden');
    }

    function startRecordingTimer() {
      clearInterval(recordingTimerInterval);
      recordingSeconds = 0;
      updateRecordingTimer();
      recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
    }

    function updateRecordingTimer() {
      recordingSeconds++;
      const m = String(Math.floor(recordingSeconds / 60)).padStart(2, "0");
      const s = String(recordingSeconds % 60).padStart(2, "0");
      document.getElementById("recording-timer").textContent = `${m}:${s}`;
    }

    document.getElementById('stop-recording').addEventListener('click', function() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(recordingTimerInterval);
        hideVoiceRecordingUI();
        showNotification('Voice note recorded', 'success');
      }
    });

    function playVoiceNote(url) {
      const audio = new Audio(url);
      audio.play();
    }

    function formatTime(seconds) {
      const m = String(Math.floor(seconds / 60)).padStart(2, "0");
      const s = String(seconds % 60).padStart(2, "0");
      return `${m}:${s}`;
    }

    /* ------------------------------
          IMAGE PREVIEW FUNCTIONS
    ------------------------------ */

    function openImagePreview(url, name = 'image.jpg') {
      document.getElementById('preview-image').src = url;
      document.getElementById('image-preview-modal').classList.remove('hidden');
    }

    function closeImagePreview() {
      document.getElementById('image-preview-modal').classList.add('hidden');
      document.getElementById('preview-image').src = '';
    }

    /* ------------------------------
          FILE PREVIEW FUNCTIONS
    ------------------------------ */

    function openFilePreview(url, name) {
      document.getElementById('file-preview-title').textContent = name;
      document.getElementById('file-preview-iframe').src = url;
      document.getElementById('file-preview-modal').classList.remove('hidden');
    }

    function closeFilePreview() {
      document.getElementById('file-preview-modal').classList.add('hidden');
      document.getElementById('file-preview-iframe').src = '';
    }

    /* ------------------------------
          DOWNLOAD FUNCTION
    ------------------------------ */

    function downloadFile(url, name) {
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    /* ------------------------------
          SEND CHAT MESSAGE
    ------------------------------ */

    document.getElementById("chat-form").onsubmit = async (ev) => {
      ev.preventDefault();
      const inp = document.getElementById("message-input");
      const msg = inp.value.trim();

      if (!msg && attachments.length === 0) return;

      const messageData = {
        message: msg,
        attachments: attachments.map(att => ({
          type: att.type,
          name: att.name,
          size: att.size,
          duration: att.duration,
          url: att.url
        }))
      };

      socket.send(JSON.stringify(messageData));

      // Clear attachments
      clearMediaPreview();
      inp.value = "";
      inp.focus();
    };

    /* ------------------------------
          USER LIST UI
    ------------------------------ */

    document.getElementById("call-icon").onclick = () => {
      renderUserList();
      document.getElementById("call-user-popup").classList.remove("hidden");
    };

    function closeUserPopup() {
      document.getElementById("call-user-popup").classList.add("hidden");
    }

    function renderUserList() {
      const ul = document.getElementById("user-list");
      ul.innerHTML = "";

      const users = Array.from(onlineUsers);

      if (users.length === 0) {
        ul.innerHTML = `
          <div class="text-center py-8">
            <div class="w-16 h-16 mx-auto mb-4 bg-gray-800 rounded-full flex items-center justify-center border border-gray-700">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
            <p class="text-gray-400">No other users online</p>
          </div>
        `;
        return;
      }

      users.forEach(u => {
        const li = document.createElement("li");
        li.className = "flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-800 cursor-pointer transition-colors border border-gray-800";
        li.onclick = () => initiateCall(u);
        
        li.innerHTML = `
          <div class="w-10 h-10 bg-gradient-to-r from-gray-700 to-gray-800 rounded-full flex items-center justify-center border border-gray-600">
            <span class="text-gray-300 font-bold">${u.charAt(0).toUpperCase()}</span>
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium text-white truncate">${u}</p>
            <p class="text-sm text-gray-400">Online</p>
          </div>
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        `;
        
        ul.appendChild(li);
      });
    }

    /* ------------------------------
         CALL INITIATION
    ------------------------------ */

    function initiateCall(username) {
      callTarget = username;
      closeUserPopup();

      console.log("Initiating call to:", username);
      socket.send(JSON.stringify({
        type: "call_request",
        target: username
      }));

      showNotification(`Calling ${username}...`, "info");

      ringTimeout = setTimeout(() => {
        console.log("Call timed out - no answer from:", username);
        showNotification("No answer", "warning");
        cleanupCall();
      }, 30000); // Increased timeout to 30 seconds
    }

    /* ------------------------------
         INCOMING CALL POPUP
    ------------------------------ */

    function showIncomingCall(from) {
      callTarget = from;
      clearTimeout(ringTimeout);

      document.getElementById("caller-name").textContent = from;
      document.getElementById("incoming-call-popup").classList.remove("hidden");
      
      // Play ringtone
      const ringtone = document.getElementById('ringtone');
      ringtone.currentTime = 0;
      ringtone.play().catch(console.error);

      ringTimeout = setTimeout(() => {
        console.log("Incoming call timed out for:", from);
        socket.send(JSON.stringify({
          type: "call_timeout",
          target: from
        }));
        cleanupCall();
        document.getElementById("incoming-call-popup").classList.add("hidden");
        ringtone.pause();
      }, 30000); // Match caller timeout
    }

    document.getElementById("accept-call").onclick = () => {
      document.getElementById("incoming-call-popup").classList.add("hidden");
      clearTimeout(ringTimeout);
      
      const ringtone = document.getElementById('ringtone');
      ringtone.pause();

      socket.send(JSON.stringify({
        type: "call_accept",
        target: callTarget
      }));
    };

    document.getElementById("reject-call").onclick = () => {
      document.getElementById("incoming-call-popup").classList.add("hidden");
      clearTimeout(ringTimeout);
      
      const ringtone = document.getElementById('ringtone');
      ringtone.pause();

      socket.send(JSON.stringify({
        type: "call_reject",
        target: callTarget
      }));

      cleanupCall();
    };

    /* ------------------------------
         CALLER — CREATE OFFER
    ------------------------------ */

    async function startAsCaller() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });

        setupPeerConnection();
        showCallUI(callTarget);

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.send(JSON.stringify({
          type: "offer",
          offer,
          target: callTarget
        }));
      } catch (error) {
        console.error("Error starting call:", error);
        showNotification("Failed to access microphone", "error");
        cleanupCall();
      }
    }

    /* ------------------------------
         RECEIVER — HANDLE OFFER
    ------------------------------ */

    async function handleOffer(offer, caller) {
      callTarget = caller;

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });
        
        setupPeerConnection();
        showCallUI(caller);

        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        socket.send(JSON.stringify({
          type: "answer",
          answer,
          target: caller
        }));
      } catch (error) {
        console.error("Error handling offer:", error);
        showNotification("Failed to join call", "error");
        cleanupCall();
      }
    }

    /* ------------------------------
         AUDIO LEVEL MONITORING
    ------------------------------ */

    function startAudioMonitoring() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(localStream);
        source.connect(analyser);
        analyser.fftSize = 32;
      }

      if (audioInterval) clearInterval(audioInterval);
      
      audioInterval = setInterval(() => {
        if (!analyser) return;
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        const level = Math.min(average / 128, 1);
        
        const audioLevel = document.getElementById('audio-level');
        if (audioLevel) {
          audioLevel.style.width = `${level * 100}%`;
        }
      }, 100);
    }

    function stopAudioMonitoring() {
      if (audioInterval) {
        clearInterval(audioInterval);
        audioInterval = null;
      }
      
      const audioLevel = document.getElementById('audio-level');
      if (audioLevel) {
        audioLevel.style.width = '0%';
      }
    }

    /* ------------------------------
         PEER CONNECTION SETUP
    ------------------------------ */

    function setupPeerConnection() {
      pc = new RTCPeerConnection(iceConfig);

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.ontrack = (ev) => {
        document.getElementById("remoteAudio").srcObject = ev.streams[0];
      };

      pc.onicecandidate = (ev) => {
        if (ev.candidate) {
          socket.send(JSON.stringify({
            type: "ice",
            candidate: ev.candidate,
            target: callTarget
          }));
        }
      };

      pc.onconnectionstatechange = () => {
        const statusEl = document.getElementById('call-status');
        if (statusEl) {
          statusEl.textContent = pc.connectionState.charAt(0).toUpperCase() + pc.connectionState.slice(1);
        }

        if (pc.connectionState === "connected") {
          startAudioMonitoring();
          showNotification("Call connected", "success");
        }

        if (pc.connectionState === "disconnected") {
          showNotification("Call connection lost, trying to reconnect...", "warning");
        }

        if (pc.connectionState === "failed" ||
            pc.connectionState === "closed") {
          stopAudioMonitoring();
          cleanupCall();
        }
      };
    }

    /* ------------------------------
         CALL UI MANAGEMENT
    ------------------------------ */

    function showCallUI(username) {
      document.getElementById("call-with").textContent = username;
      document.getElementById("active-call-ui").classList.remove("hidden");
      document.getElementById("minimized-call-ui").classList.add("hidden");
      document.getElementById("minimized-call-name").textContent = username;
      isCallMinimized = false;

      callSeconds = 0;
      updateCallTimer();
      callTimerInterval = setInterval(updateCallTimer, 1000);
    }

    function updateCallTimer() {
      callSeconds++;
      const m = String(Math.floor(callSeconds / 60)).padStart(2, "0");
      const s = String(callSeconds % 60).padStart(2, "0");
      const timerText = `${m}:${s}`;
      
      document.getElementById("call-timer").textContent = timerText;
      document.getElementById("minimized-call-timer").textContent = timerText;
    }

    function hideCallUI() {
      document.getElementById("active-call-ui").classList.add("hidden");
      document.getElementById("minimized-call-ui").classList.add("hidden");
      clearInterval(callTimerInterval);
      document.getElementById("call-timer").textContent = "00:00";
      isCallMinimized = false;
    }

    /* ------------------------------
         CALL CONTROL BUTTONS
    ------------------------------ */

    document.getElementById("end-call-btn").onclick = () => {
      socket.send(JSON.stringify({
        type: "call_reject",
        target: callTarget
      }));
      cleanupCall();
      showNotification("Call ended", "info");
    };

    document.getElementById("mute-btn").onclick = () => {
      if (localStream) {
        const track = localStream.getAudioTracks()[0];
        track.enabled = !track.enabled;
        
        const muteIcon = document.getElementById('mute-icon');
        const muteText = document.querySelector('#mute-btn span');
        
        if (!track.enabled) {
          muteIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />`;
          muteText.textContent = "Muted";
          showNotification("Microphone muted", "info");
        } else {
          muteIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />`;
          muteText.textContent = "Mute";
          showNotification("Microphone unmuted", "info");
        }
      }
    };

    document.getElementById("speaker-btn").onclick = () => {
      const remoteAudio = document.getElementById('remoteAudio');
      remoteAudio.muted = !remoteAudio.muted;
      
      const speakerText = document.querySelector('#speaker-btn span');
      if (remoteAudio.muted) {
        speakerText.textContent = "Muted";
        showNotification("Speaker muted", "info");
      } else {
        speakerText.textContent = "Speaker";
        showNotification("Speaker unmuted", "info");
      }
    };

    /* ------------------------------
         CALL MINIMIZE/RESTORE
    ------------------------------ */

    document.getElementById("minimize-call").onclick = () => {
      document.getElementById("active-call-ui").classList.add("hidden");
      document.getElementById("minimized-call-ui").classList.remove("hidden");
      isCallMinimized = true;
    };

    document.getElementById("restore-call").onclick = () => {
      document.getElementById("active-call-ui").classList.remove("hidden");
      document.getElementById("minimized-call-ui").classList.add("hidden");
      isCallMinimized = false;
    };

    /* ------------------------------
         CLEANUP CALL
    ------------------------------ */

    function cleanupCall() {
      if (pc) {
        pc.close();
        pc = null;
      }

      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }

      callTarget = null;
      clearTimeout(ringTimeout);
      
      stopAudioMonitoring();
      
      const ringtone = document.getElementById('ringtone');
      ringtone.pause();
      
      hideCallUI();
    }

    /* ------------------------------
         CAMERA PREVIEW FUNCTIONS
    ------------------------------ */

    let cameraStream = null;

    async function openCameraPreview() {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });

        const video = document.getElementById('camera-video');
        video.srcObject = cameraStream;
        document.getElementById('camera-preview-modal').classList.remove('hidden');
      } catch (error) {
        console.error('Error accessing camera:', error);
        showNotification('Cannot access camera', 'error');
      }
    }

    function closeCameraPreview() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      document.getElementById('camera-preview-modal').classList.add('hidden');
    }

    document.getElementById('capture-btn').addEventListener('click', async function() {
      if (!cameraStream) return;

      const video = document.getElementById('camera-video');
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async (blob) => {
        const filename = `camera_photo_${Date.now()}.jpg`;
        const file = new File([blob], filename, { type: 'image/jpeg' });
        await previewFile(file, true);
        closeCameraPreview();
        showNotification('Photo captured', 'success');
      }, 'image/jpeg', 0.8);
    });

    /* ------------------------------
         WEBSOCKET ERROR HANDLING
    ------------------------------ */

    socket.onclose = () => {
      showNotification("Connection lost. Reconnecting...", "error");
      setTimeout(() => location.reload(), 3000);
    };

    socket.onerror = (error) => {
      console.error("WebSocket error:", error);
    };

    /* ------------------------------
         INITIALIZATION
    ------------------------------ */

    window.addEventListener('beforeunload', () => {
      if (pc) {
        cleanupCall();
      }
    });

    // Focus input on load
    document.getElementById("message-input").focus();

  </script>

</body>
</html>